{"version":3,"file":"main.js","sourceRoot":"/","sources":["main.ts"],"names":[],"mappings":";;;AACA,6CAAoC;AACpC,kFAG2B;AAC3B,sFAM6B;AAO7B,MAAa,eAAgB,SAAQ,2BAAS;IAG5C,YAAY,MAAwC;QAClD,KAAK,CAAC,MAAM,CAAC,CAAC;QACd,IAAI,MAAM,CAAC,QAAQ,EAAE;YACnB,IAAI,CAAC,OAAO,GAAG,6BAAE,CAAC,MAAM,CAAC,SAAS,EAAE,MAAM,CAAC,QAAQ,EAAE;gBACnD,eAAe,EAAE,KAAK;aACvB,CAAC,CAAC;SACJ;aAAM;YACL,IAAI,CAAC,OAAO,GAAG,6BAAE,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;SACrC;IACH,CAAC;IAEK,GAAG,CAAC,IAAS,EAAE,QAAuC;;YAC1D,MAAM,EAAE,KAAK,EAAE,OAAO,KAAc,IAAI,EAAhB,iDAAgB,CAAC;YAEzC,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,mBAAK,CAAC,EAAE;gBACzB,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBACpB,QAAQ,CAAC,IAAI,CAAC,CAAC;gBACf,OAAO;aACR;YAED,MAAM,CAAC,CAAC,EAAE,MAAM,CAAC,GAAG,IAAI,CAAC,mBAAK,CAAC,CAAC;YAEhC,IAAI,CAAC,MAAM,EAAE;gBACX,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBACpB,QAAQ,CAAC,IAAI,CAAC,CAAC;gBACf,OAAO;aACR;YAED,IAAI,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,EAAE;gBAC9B,IAAI;oBACF,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,CAAC;oBACxC,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;iBAC7B;gBAAC,OAAO,CAAC,EAAE;oBACV,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;oBACnB,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;iBACvB;aACF;YAED,IAAI,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,EAAE;gBACjC,IAAI;oBACF,MAAM,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;oBAChC,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;iBAC7B;gBAAC,OAAO,CAAC,EAAE;oBACV,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;oBACnB,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;iBACvB;aACF;YAED,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,gBAAgB,CAAC,CAAC;YACrC,OAAO,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QAC/B,CAAC;KAAA;IAEO,aAAa,CAAC,MAAW;QAC/B,OAAO,MAAM,CAAC,EAAE,IAAI,MAAM,CAAC,EAAE,CAAC;IAChC,CAAC;IAEO,gBAAgB,CAAC,MAAW;QAClC,OAAO,MAAM,CAAC,EAAE,IAAI,MAAM,CAAC,EAAE,CAAC;IAChC,CAAC;CACF;AA9DD,0CA8DC","sourcesContent":["import * as path from 'path';\nimport { SPLAT } from 'triple-beam';\nimport {\n  default as Transport,\n  TransportStreamOptions,\n} from 'winston-transport';\nimport {\n  default as ua,\n  EventParams,\n  PageviewParams,\n  Visitor,\n  VisitorOptions,\n} from 'universal-analytics';\nexport type GoogleAnalyticsConstructorParams = TransportStreamOptions & {\n  accountID: string;\n  clientID?: string;\n};\nexport type GoogleAnalyticsLogParams = EventParams | PageviewParams;\n\nexport class GoogleAnalytics extends Transport {\n  private visitor: Visitor;\n\n  constructor(params: GoogleAnalyticsConstructorParams) {\n    super(params);\n    if (params.clientID) {\n      this.visitor = ua(params.accountID, params.clientID, {\n        strictCidFormat: false,\n      });\n    } else {\n      this.visitor = ua(params.accountID);\n    }\n  }\n\n  async log(info: any, callback: (_: any, __: boolean) => void) {\n    const { label, message, ...meta } = info;\n\n    if (!meta || !meta[SPLAT]) {\n      this.emit('finish');\n      callback(null);\n      return;\n    }\n\n    const [_, params] = meta[SPLAT];\n\n    if (!params) {\n      this.emit('finish');\n      callback(null);\n      return;\n    }\n\n    if (this.isEventParams(params)) {\n      try {\n        await this.visitor.event(params).send();\n        return callback(null, true);\n      } catch (e) {\n        this.emit('error');\n        callback(null, false);\n      }\n    }\n\n    if (this.isPageviewParams(params)) {\n      try {\n        await this.sendPageview(params);\n        return callback(null, true);\n      } catch (e) {\n        this.emit('error');\n        callback(null, false);\n      }\n    }\n\n    this.emit('error', 'nothing passed');\n    return callback(null, false);\n  }\n\n  private isEventParams(params: any): params is EventParams {\n    return params.ec && params.ea;\n  }\n\n  private isPageviewParams(params: any): params is PageviewParams {\n    return params.dp && params.dh;\n  }\n}\n"]}